{{- range $name, $tenant := .Values.tenants }}
{{- $tenantConfig := $tenant | default dict -}}
{{- $flux := $tenantConfig.flux | default dict -}}
{{- if (($flux.tenantAdminRole).enabled) | default true -}}
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: tenant-admin
  namespace: {{ $name }}
  labels:
    platform/type: tenant
    {{- include "tenant-provision.labels" $ | nindent 4 }}
rules:
- apiGroups: [""] # "" indicates the core API group
  resources:
  - bindings
  - configmaps
  - endpoints
  - events
  - limitranges
  - persistentvolumeclaims
  - pods
  - podtemplates
  - replicationcontrollers
  - resourcequotas
  - secrets
  - serviceaccounts
  - services
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["apps", "autoscaling", "batch", "policy"] #Other Core functions API groups
  resources:
  - controllerrevisions                    
  - daemonsets                
  - deployments
  - replicasets
  - statefulsets
  - horizontalpodautoscalers
  - cronjobs
  - jobs
  - poddisruptionbudgets
  - deletecollection
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups: ["admissionregistration.k8s.io", "certificates.k8s.io", "metrics.k8s.io", "networking.k8s.io" ] # Extended core API groups
  resources:
  - pods
  - ingresses
  - networkpolicies
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["helm.toolkit.fluxcd.io", "source.toolkit.fluxcd.io", "kustomize.toolkit.fluxcd.io", "notification.toolkit.fluxcd.io"] # Flux API groups
  resources:
  - alerts
  - providers
  - receivers
  - helmreleases
  - buckets
  - gitrepositories
  - helmcharts
  - helmrepositories 
  - kustomizations
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["storage.k8s.io", "snapshot.storage.k8s.io"] # Storage API group
  resources:
  - csistoragecapacities
  - volumesnapshots 
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["coordination.k8s.io"] # Coordination API group
  resources:
  - leases
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["discovery.k8s.io"] # Discovery API group
  resources:
  - endpointslices
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["rbac.authorization.k8s.io", "authorization.k8s.io"] # Authorization API group
  resources:
  - localsubjectaccessreviews
  - rolebindings
  - roles
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["spv.no"] # spv.no API group
  resources:
  - azurekeyvaultsecrets
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["kyverno.io", "wgpolicyk8s.io"] # kyverno API group
  resources:
  - generaterequests
  - policies
  - reportchangerequests
  - updaterequests
  - policyreports
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["cert-manager.io", "acme.cert-manager.io"] # cert-manager API group
  resources:
  - certificaterequests
  - certificates
  - challenges
  - issuers
  - orders
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["install.istio.io", "security.istio.io", "networking.istio.io", "config.istio.io", "rbac.istio.io", "authentication.istio.io", "mixer.validation.istio.io", "extensions.istio.io", "telemetry.istio.io", "kiali.io"] # Istio API group
  resources:
  - peerauthentications
  - httpapispecs
  - httpapispecbindings
  - quotaspecs
  - quotaspecbindings
  - destinationrules
  - envoyfilters
  - gateways
  - serviceentries
  - virtualservices
  - kialis
  - wasmplugins
  - istiooperators
  - proxyconfigs
  - sidecars
  - workloadentries
  - workloadgroups
  - authorizationpolicies
  - requestauthentications
  - telemetries
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["jaegertracing.io"] # jaeger API group
  resources:
  - jaegers
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["rabbitmq.com"] # rabbitmq API group
  resources:
  - binding
  - bindinglist
  - exchange
  - exchangelist
  - federation
  - federationlist
  - permission
  - permissionlist
  - policy
  - policylist
  - queue
  - queuelist
  - schemareplication
  - schemareplicationlist
  - shovel
  - shovellist
  - user
  - userlist
  - vhost
  - vhostlist
  - superstream
  - superstreamlist
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["monitoring.coreos.com"] # promstack API group
  resources:
  - servicemonitors
  - alertmanagerconfigs
  - alertmanagers
  - podmonitors
  - probes
  - prometheuses
  - prometheusrules
  - thanosrulers
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["velero.io"] # velero API group
  resources:
  - backups
  - backupstoragelocations
  - deletebackuprequests
  - downloadrequests
  - podvolumebackups
  - podvolumerestores
  - resticrepositories
  - restores
  - schedules
  - serverstatusrequests
  - volumesnapshotlocations
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
- apiGroups: ["keda.sh"] # keda API group
  resources:
  - scaledjobs
  - scaledobjects
  - triggerauthentications
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
  - deletecollection
  {{- end }}
---
{{- end }}
